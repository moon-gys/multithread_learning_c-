## 线程池

<https://www.jianshu.com/p/210eab345423>
<https://www.cnblogs.com/ailumiyana/p/10016965.html>

### 为什么使用线程池

目前的大多数网络服务器，包括Web服务器、Email服务器以及数据库服务器等都具有一个共同点，就是单位时间内必须处理数目巨大的连接请求，但处理时间却相对较短。传统多线程方案中我们采用的服务器模型则是一旦接受到请求之后，即创建一个新的线程，由该线程执行任务。任务执行完毕后，线程退出，这就是是“即时创建，即时销毁”的策略。

尽管与创建进程相比，创建线程的时间已经大大的缩短，但是如果提交给线程的任务是执行时间较短，而且执行次数极其频繁，那么服务器将处于不停的创建线程，销毁线程的状态。

1. 创建/销毁线程伴随的系统开销，频繁的创建/销毁线程影响处理效率。
```
例如：
记创建线程消耗时间T1，执行任务消耗时间T2，销毁线程消耗时间T3

如果T1+T3>T2，那么是不是说开启一个线程来执行这个任务太不划算了！

正好，线程池缓存线程，可用已有的闲置线程来执行新任务，避免了T1+T3带来的系统开销
```
2. 线程并发数量过多，抢占系统资源从而导致阻塞
```
线程能共享资源，如果同时执行的线程过多，就有可能导致系统资源不足而产生阻塞的情况。

运用线程池能有有效的控制线程的最大并发数，避免上述问题。
```
3. 对线程进行一些简单的管理
```
延时执行、定时循环执行的策略
```
### 什么是线程池

线程池（thread pool）是一种线程使用模式。线程过多或者频繁创建和销毁线程会带来调度开销，进而影响缓存局部性和整体性能。而线程池维护着多个线程，等待着管理器分配可并发执行的任务。这避免了在处理短时间任务时创建与销毁线程的代价，以及保证了线程的可复用性。线程池不仅能够保证内核的充分利用，还能防止过分调度。

可用线程数量应该取决于可用的并发处理器、处理器内核、内存、网络sockets等的数量。

### 线程池的组成部分

- 线程池管理器（ThreadPool
  - 创建并管理线程池，包括创建、销毁线程池、添加新任务等。
- 工作队列（PoolWorker）
  - 线程池中的线程，在没有任务时处于等待状态，可以循环的执行任务。
- 任务接口（Task）
  - 每个任务必须实现的接口，以供工作线程调度任务的执行，它主要规定了任务的入口，执行任务完成后的首尾工作，任务的执行状态等。
- 任务队列（taskQueue)
  - 用于存放没有处理的任务。提供一种缓冲机制。
  
  线程池的外部支持
  
  - 锁
  - 条件变量

### 线程池工作的四种情况

假设线程池大小为3，任务队列不做限制

- 主程序当前没有任何任务要执行，线程池中的任务队列为空闲状态
- 主程序添加小于等于线程池中线程数量的任务
- 主程序添加大于任务数量大于当前线程池中的线程数量的任务
- 主程序添加任务数量大于当前线程池中线程数量的任务，且任务缓冲队列已满

**1主程序当前没有任何任务要执行，线程池中的任务队列为空闲状态**
<img="images/one.png" height=399 lenght=450>
**2 主程序添加小于等于线程池中线程数量的任务**
<img="images/two.png" height=399 lenght=450>
**3 主程序添加大于任务数量大于当前线程池中的线程数量的任务**
<img="images/three.png" height=399 lenght=450>
**4 主程序添加任务数量大于当前线程池中线程数量的任务，且任务缓冲队列已满**
<img="images/four.png" height=399 lenght=450>

### code


